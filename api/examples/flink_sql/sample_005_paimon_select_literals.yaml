task_type: flink_sql
name: Paimon SQL Sample
description: Create catalog; create table; insert data and then select all.
task_timeout_seconds: 300

# TODO: allow internal dynamic variables like ${__NOW_TS10__}
# TODO: allow downloading variables from resink.ai
job:
  sql: |
    -- Create Paimon catalog

    DROP CATALOG IF EXISTS my_catalog;

    CREATE CATALOG my_catalog WITH (
        'type'='paimon',
        'warehouse'='file:/tmp/paimon_${__NOW_TS10__}'
    );

    USE CATALOG my_catalog;

    DROP TABLE IF EXISTS MyTable;

    -- Create table with Paimon-specific options
    CREATE TABLE MyTable (
        user_id BIGINT,
        item_id BIGINT,
        behavior STRING,
        dt STRING,
        PRIMARY KEY (dt, user_id) NOT ENFORCED
    ) PARTITIONED BY (dt) WITH (
        'bucket' = '4',
        'changelog-producer' = 'input'
    );

    INSERT INTO MyTable (user_id, item_id, behavior, dt) VALUES
        (1001, 5001, 'view', '2024-01-01'),
        (1001, 5002, 'like', '2024-01-01'),
        (1002, 5001, 'cart', '2024-01-01'),
        (1003, 5003, 'purchase', '2024-01-01'),
        (1001, 5004, 'view', '2024-01-02'),
        (1002, 5002, 'view', '2024-01-02'),
        (1002, 5002, 'like', '2024-01-02'),
        (1003, 5001, 'cart', '2024-01-02'),
        (1004, 5005, 'view', '2024-01-02'),
        (1001, 5003, 'purchase', '2024-01-03'),
        (1002, 5004, 'view', '2024-01-03'),
        (1003, 5002, 'like', '2024-01-03'),
        (1004, 5001, 'cart', '2024-01-03'),
        (1005, 5005, 'purchase', '2024-01-03'),
        (1001, 5001, 'view', '2024-01-04');

    -- For batch query
    SET 'execution.runtime-mode' = 'batch';
    -- Remove the invalid orders table query
    -- Instead query the created table
    SELECT * FROM MyTable;

  pipeline:
    name: select from datagen
    parallelism: 1

resources:
  flink_jars:
    - name: paimon-flink-1.19-1.0.1.jar
      type: lib
      source: download
      location: https://repo.maven.apache.org/maven2/org/apache/paimon/paimon-flink-1.19/1.0.1/paimon-flink-1.19-1.0.1.jar
